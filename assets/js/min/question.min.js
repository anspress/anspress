!function(a){AnsPress.loadTemplate("question"),AnsPress.models.Action=Backbone.Model.extend({defaults:{cb:"",post_id:"",title:"",label:"",query:"",active:!1,header:!1,href:"#",count:"",prefix:""}}),AnsPress.collections.Actions=Backbone.Collection.extend({model:AnsPress.models.Action}),AnsPress.views.Action=Backbone.View.extend({id:function(){return this.postID},className:function(){var a="";return this.model.get("header")&&(a+=" ap-dropdown-header"),this.model.get("active")&&(a+=" active"),a},tagName:"li",template:AnsPress.getTemplate("action"),initialize:function(a){this.model=a.model,this.postID=a.postID,this.model.on("change",this.render,this)},events:{"click a":"triggerAction"},render:function(){var a=_.template(this.template());return this.$el.html(a(this.model.toJSON())),this.$el.attr("class",this.className()),this},triggerAction:function(a){var b=this.model.get("query");if(!_.isEmpty(b)){a.preventDefault();var c=this;AnsPress.showLoading(a.target);var d=this.model.get("cb");b.ap_ajax_action="action_"+d,AnsPress.ajax({data:b,success:function(b){AnsPress.hideLoading(a.target),b.redirect&&(window.location=b.redirect),!b.success||"status"!=d&&"toggle_delete_post"!=d||AnsPress.trigger("changedPostStatus",{postID:c.postID,data:b,action:c.model}),b.action&&c.model.set(b.action),b.postMessage&&c.renderPostMessage(b.postMessage),b.deletePost&&AnsPress.trigger("deletePost",b.deletePost),b.answersCount&&AnsPress.trigger("answerCountUpdated",b.answersCount)}})}},renderPostMessage:function(b){_.isEmpty(b)?a("#post-"+this.postID).find("post-message").html(""):a("#post-"+this.postID).find("post-message").html(b)}}),AnsPress.views.Actions=Backbone.View.extend({id:function(){return this.postID},tagName:"ul",className:"ap-actions",initialize:function(a){this.model=a.model,this.postID=a.postID,AnsPress.on("changedPostStatus",this.postStatusChanged,this)},renderItem:function(a){var b=new AnsPress.views.Action({model:a,postID:this.postID});this.$el.append(b.render().$el)},render:function(){var a=this;return this.model.each(function(b){a.renderItem(b)}),this},postStatusChanged:function(b){if(b.postID===this.postID){a("#post-"+this.postID).removeClass(function(){return this.className.split(" ").filter(function(a){return a.match(/status-/)}).join(" ")}),a("#post-"+this.postID).addClass("status-"+b.data.newStatus);var c=this.model.where({cb:"status",active:!0});c.forEach(function(a){a.set({active:!1})})}}}),AnsPress.models.Post=Backbone.Model.extend({idAttribute:"ID",defaults:{actionsLoaded:!1,hideSelect:""}}),AnsPress.models.Comment=Backbone.Model.extend({idAttribute:"ID",defaults:{ID:"",userID:"",avatar:"",content:"",actions:""}}),AnsPress.collections.Comments=Backbone.Collection.extend({model:AnsPress.models.Comment}),AnsPress.views.Comment=Backbone.View.extend({tagName:"ap-comment",id:function(){return"comment-"+this.model.id},className:function(){var a=this.model.get("class");return"0"===this.model.get("approved")&&(a+=" unapproved"),a},template:AnsPress.getTemplate("comment"),initialize:function(a){this.model=a.model,this.postID=a.postID,this.model.on("change",this.render,this)},events:{'click [ap="comment_action"]':"actions",'click [ap="edit_comment"]':"editCommentForm"},render:function(){var a=_.template(this.template());return this.$el.html(a(this.model.toJSON())),this.$el.attr("class",this.className()),this},actions:function(b){b.preventDefault();var c=this,d=a.parseJSON(a(b.target).attr("ap-query"));AnsPress.showLoading(b.target),AnsPress.ajax({data:d,success:function(a){AnsPress.hideLoading(b.target),a.success&&(a.model&&c.model.set(a.model),a.commentsCount&&AnsPress.trigger("commentCount",{count:a.commentsCount,postID:c.postID}),"delete_comment"===a.action&&AnsPress.trigger("removeComment",c.model))}})},editCommentForm:function(a){a.preventDefault(),AnsPress.trigger("loadCommentEdit",{postID:this.postID,e:a,comment:this.model})}}),AnsPress.views.Comments=Backbone.View.extend({initialize:function(a){this.model=a.model,this.postID=a.postID,AnsPress.on("removeComment",this.removeComment,this),this.listenTo(this.model,"remove",this.commentRemoved),this.listenTo(this.model,"add",this.newComment)},renderItem:function(a){this.$el.parent().addClass("have-comments");var b=new AnsPress.views.Comment({model:a,postID:this.postID});return this.$el.append(b.render().$el),b},render:function(){var a=this;return this.model.length>0&&this.model.each(function(b){a.renderItem(b)}),this},removeComment:function(a){this.model.remove(a)},commentRemoved:function(b){0===this.model.size()&&this.$el.parent().removeClass("have-comments"),a("#comment-"+b.id).slideUp(400,function(){a(this).remove()})},newComment:function(a){var b=this.renderItem(a);b.$el.hide().slideDown(400),this.$el.apScrollTo("#comment-"+a.id)}}),AnsPress.views.Post=Backbone.View.extend({idAttribute:"ID",templateId:"answer",tagName:"div",actions:{view:{},model:{}},id:function(){return"post-"+this.model.get("ID")},initialize:function(a){this.listenTo(this.model,"change:vote",this.voteUpdate),this.listenTo(this.model,"change:hideSelect",this.selectToggle),this.listenTo(AnsPress,"commentCount",this.commentCount),this.listenTo(AnsPress,"loadCommentEdit",this.loadCommentEdit)},events:{"click [ap-vote] > a":"voteClicked",'click [ap="actiontoggle"]:not(.loaded)':"postActions",'click [ap="select_answer"]':"selectAnswer",'click [ap="comment_btn"]':"loadComments",'click [ap="new-comment"]':"loadCommentForm","submit [comment-form]":"submitComment",'click [ap="cancel-comment"]':"hideCommentForm"},voteClicked:function(b){if(b.preventDefault(),!a(b.target).is(".disable")){self=this;var c=a(b.target).is(".vote-up")?"vote_up":"vote_down",d=_.clone(self.model.get("vote")),e=_.clone(d);"vote_up"===c?e.net="vote_up"===e.active?e.net-1:e.net+1:e.net="vote_down"===e.active?e.net+1:e.net-1,self.model.set("vote",e);var f=a.parseJSON(a(b.target).parent().attr("ap-vote"));f.ap_ajax_action="vote",f.type=c,AnsPress.ajax({data:f,success:function(a){a.success&&_.isObject(a.voteData)?self.model.set("vote",a.voteData):self.model.set("vote",d)}})}},voteUpdate:function(a){var b=this;this.$el.find('[ap="votes_net"]').text(this.model.get("vote").net),_.each(["up","down"],function(a){b.$el.find(".vote-"+a).removeClass("voted disable").addClass(b.voteClass("vote_"+a))})},voteClass:function(a){a=a||"vote_up";var b=this.model.get("vote").active,c="";return"vote_up"===b&&"vote_up"===a&&(c="active"),"vote_down"===b&&"vote_down"===a&&(c="active"),a!==b&&""!==b&&(c+=" disable"),c+" prist"},render:function(){var b=this.$el.find("[ap-vote]").attr("ap-vote");return this.model.set("vote",a.parseJSON(b),{silent:!0}),this},postActions:function(b){var c=this,d=a.parseJSON(a(b.target).attr("ap-query"));d.ap_ajax_action="post_actions",AnsPress.ajax({data:d,success:function(d){AnsPress.hideLoading(b.target),a(b.target).addClass("loaded"),c.actions.model=new AnsPress.collections.Actions(d.actions),c.actions.view=new AnsPress.views.Actions({model:c.actions.model,postID:c.model.get("ID")}),c.$el.find("postActions .ap-actions").html(c.actions.view.render().$el)}})},selectAnswer:function(b){b.preventDefault();var c=this,d=a.parseJSON(a(b.target).attr("ap-query"));d.ap_ajax_action="toggle_best_answer",AnsPress.ajax({data:d,success:function(d){AnsPress.hideLoading(b.target),d.success&&("selected"===d.action?(c.$el.addClass("best-answer"),a(b.target).addClass("active").text(d.label),AnsPress.trigger("answerToggle",[c.model,!0])):(c.$el.removeClass("best-answer"),a(b.target).removeClass("active").text(d.label),AnsPress.trigger("answerToggle",[c.model,!1])))}})},selectToggle:function(){this.model.get("hideSelect")?this.$el.find('[ap="select_answer"]').addClass("hide"):this.$el.find('[ap="select_answer"]').removeClass("hide")},loadComments:function(b){b.preventDefault();var c=this,d=a(b.currentTarget),e="#comments-"+c.model.id;if(d.is(".loaded"))return void(a(e).is(".have-comments")?a(e).find(".ap-comments").slideUp(400,function(){a(e).removeClass("have-comments")}):c.comments.length>0&&a(e).addClass("have-comments").find(".ap-comments").slideDown(400));var f=a.parseJSON(d.attr("ap-query"));f.ap_ajax_action="load_comments",AnsPress.showLoading(d),AnsPress.ajax({data:f,success:function(a){AnsPress.hideLoading(d),d.addClass("loaded"),c.comments=new AnsPress.collections.Comments(a.comments);var b=new AnsPress.views.Comments({model:c.comments,postID:c.model.id,el:e+" .ap-comments"});b.render(),b.$el.hide().slideDown(400)}})},loadCommentForm:function(b,c){if(b.preventDefault(),0===this.$el.find("[comment-form]").length){var d=a.parseJSON(a(b.target).attr("ap-query")),e=_.template(AnsPress.getTemplate("comment-form")());this.$el.find("ap-comments").append(e(d)),this.$el.find("[comment-form]").hide().slideDown(400,function(){a(this).find("textarea").focus()})}else this.$el.find("[comment-form]").slideUp(400,function(){a(this).remove()})},loadCommentEdit:function(b){if(this.model.id===b.postID){this.$el.find("[comment-form]").length>0&&this.$el.find("[comment-form]").remove();var c=a.parseJSON(a(b.e.target).attr("ap-query")),d=_.template(AnsPress.getTemplate("comment-form")());this.$el.find("ap-comments").append(d(c)),this.$el.find("[comment-form]").hide().slideDown(400,function(){a(this).find("textarea").val(b.comment.get("content")).focus()})}},submitComment:function(b){var c=this;return AnsPress.showLoading(b.target),AnsPress.ajax({data:a(b.target).serialize(),success:function(a){AnsPress.hideLoading(b.target),a.success&&(c.comments&&"new-comment"===a.action&&c.comments.add(a.comment),c.comments&&"edit-comment"===a.action&&c.comments.get(a.comment.ID).set(a.comment),a.commentsCount&&AnsPress.trigger("commentCount",{count:a.commentsCount,postID:c.model.id}),c.$el.find("[comment-form]").remove())}}),!1},hideCommentForm:function(b){b.preventDefault(),a(b.target).closest("[comment-form]").remove()},commentCount:function(a){this.model.id===a.postID&&(this.$el.find("[ap-commentscount-text]").text(a.count.text),a.count.unapproved>0?this.$el.find("[ap-un-commentscount]").addClass("have"):this.$el.find("[ap-un-commentscount]").removeClass("have"),this.$el.find("[ap-un-commentscount]").text(a.count.unapproved))}}),AnsPress.collections.Posts=Backbone.Collection.extend({model:AnsPress.models.Post,initialize:function(){var b=[];a('[ap="question"],[ap="answer"]').each(function(c){b.push({ID:a(this).attr("ap-id")})}),this.add(b)}}),AnsPress.views.SingleQuestion=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"add",this.renderItem),AnsPress.on("answerToggle",this.answerToggle,this),AnsPress.on("deletePost",this.deletePost,this),AnsPress.on("answerCountUpdated",this.answerCountUpdated,this)},events:{'click [ap="loadEditor"]':"loadEditor",'submit [ap="answerForm"]':"answerForm"},renderItem:function(a){var b=new AnsPress.views.Post({model:a,el:"#post-"+a.get("ID")});b.render()},render:function(){var a=this;return this.model.each(function(b){a.renderItem(b)}),a},loadEditor:function(b){AnsPress.showLoading(b.target),AnsPress.ajax({data:a(b.target).attr("ap-query"),success:function(c){AnsPress.hideLoading(b.target),a(".ap-field-description").html(c),a(b.target).closest(".ap-minimal-editor").removeClass("ap-minimal-editor")}})},answerForm:function(b){var c=this;return AnsPress.showLoading(a(b.target).find(".ap-btn-submit")),a(b.target).find(".have-error").removeClass("have-error"),a(b.target).find(".error").remove(),AnsPress.ajax({data:a(b.target).serialize(),success:function(d){return d.redirect?void(window.location=d.redirect):("undefined"!=typeof grecaptcha&&"undefined"!=typeof widgetId1&&grecaptcha.reset(widgetId1),AnsPress.trigger("answerFormPosted",d),AnsPress.hideLoading(a(b.target).find(".ap-btn-submit")),AnsPress.uploader&&AnsPress.uploader.splice(),d.success&&(a("ap-answers-w").show(),a("#description").val(""),"undefined"!=typeof tinyMCE&&d.success&&tinyMCE.activeEditor.setContent(""),a("ap-answers").append(a(d.html).hide()),a(d.div_id).slideDown(800),c.model.add({ID:d.ID}),AnsPress.trigger("answerCountUpdated",d.answersCount)),void(d.errors&&_.each(d.errors,function(b,c){a(".ap-field-"+c).addClass("have-error"),"description"===c&&a(".ap-field-ap_upload").length>0&&(c="ap_upload"),a(".ap-field-"+c).append('<span class="error">'+b+"</span>")})))}}),!1},answerToggle:function(a){this.model.forEach(function(b,c){a[0]!==b&&b.set("hideSelect",a[1])})},deletePost:function(b){this.model.remove(b),a("#post-"+b).slideUp(400,function(){a(this).remove()})},answerCountUpdated:function(b){a("[ap-answerscount-text]").text(b.text)}}),AnsPress.views.Modal=Backbone.View.extend({id:"ap-modal",className:"ap-modal",template:AnsPress.getTemplate("modal"),events:{"click [close-modal]":"hide"},initialize:function(a){this.data=a},render:function(){var a=_.template(this.template());return this.$el.html(a(this.data)),this},hide:function(a){a.preventDefault(),this.remove()}});var b=Backbone.Router.extend({routes:{"comment/:commentID":"commentRoute"},commentRoute:function(b,c){AnsPress.ajax({data:ajaxurl+"?action=ap_ajax&ap_ajax_action=get_comment&comment_id="+b,success:function(b){if(b.success){var c=new AnsPress.collections.Comments(b.comment),d=new AnsPress.views.Modal({content:'<ap-comments class="have-comments"><div class="ap-comments"></div></ap-comments>',size:"medium"});a("body").append(d.render().$el);var e=new AnsPress.views.Comments({model:c,el:d.$el.find(".ap-comments")});d.$el.find(".ap-modal-content").html(e.render().$el)}}})}});a('[ap="actiontoggle"]').click(function(){a(this).is(".loaded")||AnsPress.showLoading(this)}),a(document).ready(function(){var c=new AnsPress.collections.Posts,d=new AnsPress.views.SingleQuestion({model:c,el:"#anspress"});d.render();new b;Backbone.History.started||Backbone.history.start(),apShowComments&&a('[ap="comment_btn"]').each(function(){a(this).click()})})}(jQuery);